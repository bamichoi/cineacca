{% extends "base.html" %}

{% block page_title %}
    {{movie.title}}
{% endblock page_title %}


{% block people_search_bar %}
{% endblock people_search_bar %}

{% block content %}

<h1>{{movie.title}}</h1>
<h2>{{movie.user}}</h2>
<!--player-->

<div id=videoPlayer> 
    <video src="{{ movie.video.url }}" control></video>
    <div id="videoController">
        <button id="play">Play</button>
        <button id="mute">Mute</button>
        <input id="volume" type="range" value=0.5 step="0.1", min="0", max="1" />
        <div>
            <span id="currentTime">00:00:00</span>
            <span>/</span>
            <span id="totalTime"></span>
        </div>
        <input id="timeline" type="range" value=0 step="1" min="0" />
        <div>
            <button id="fullScreen">Enter Fullscreen</button>
        </div>
    </div>
</div>

<!--player-->
<h4>description</h4>
    <div>
        <p>{{movie.description}}</p>
    </div>
</div>
<div>
    <ul>
        <li>director : {{movie.director}} </li>
        <li>screenwriter : {{movie.screenwriter}} </li>
        <li>casting : {{movie.casting}}</li>
        <li>editor  : {{movie.editor}}</li>
        <li>director_of_photograpy  : {{movie.director_of_photograpy}}</li>
        <li>audio_director : {{movie.audio_director}}</li>
        <li>music : {{movie.music}}</li>
        <li>art_director : {{movie.art_director}}</li>
        <li>costume_designer : {{movie.costume_designer}}</li>
        <li>makeup_artist : {{movie.makeup_artist}}</li>
        <li>spacial_effect_supervisor : {{movie.special_effect_supervisor}}</li>
        <li>sound_designer : {{movie.sound_designer}}</li>
    </ul>
</div>
{% if movie.user == user %}
<a href="{% url 'movies:update' movie.pk %}"><div>Update this movie</div></a>
<a href="{% url 'movies:delete' movie.pk %}"><div>Delete this movie</div></a>
{% endif %}
<div> Rate : {{movie.rating}}</div>
<div> {{movie.views}} views </div>
<h4>Reviwes</h4>
{% if user.is_authenticated %}
    {% if user.email_verified %}
        <div>
            {% include "reviews/review_form.html" %}
        </div>
    {% else %}
        <div>only user that have done the email verification could write a review</div>
    {% endif %}
{% else %}
    <div> To write a review you need to do login</div>        
{% endif %}

<div>
    <ul id="reviews">
        <li class="new_review" hidden="true">
            <div class="review_box">
                <div class="review_title"></div>
                <div class="review_user">{{ request.user }}</div>
                <div class="review_rate">rate : </div>
                <div class="review_content"></div>
                <button class= "delete" value="">delete</button></a>
                <button class="modify" value="">modify</button>
            </div>
            <form class="modify_form" hidden=true >
                {% csrf_token %}
                <p>
                    <label for="modify_title">Title</label>
                    <input type="text" name="title" maxlengh="300" required id="modify_title" value="">
                </p>
                <p>
                    <label for="modify_rate">Rate</label>
                    <input type="number" name="rate" maxlengh="300" required id="modify_rate" value="">
                </p>
                <p>
                    <label for="modify_content">Text</label>
                    <textarea name="rate" maxlengh="300" required id="modify_content" ></textarea>
                </p>
                <button class="cancel">cancel</button>
                <button class="update">update</button>
            </form>
        </li>

        {% for review in movie.reviews.all %}
        <li id="{{review.pk}}">
            <div class="review_box">
                <div class="review_title">{{review.title}}</div>
                <div class="review_user">{{review.user}}</div>
                <div class="review_rate">rate : {{review.rate}}</div>
                <div class="review_content">{{review.content}}</div>
            {% if review.user == user %}
            <button class="delete" value="{{review.pk}}">delete</button></a>
            <button class="modify" value="{{review.pk}}">modify</button>
            {% endif %}
            </div>
            <form class="modify_form" hidden=true >
                {% csrf_token %}
                <p>
                    <label for="modify_title">Title</label>
                    <input type="text" name="title" maxlengh="300" required id="modify_title" value="{{review.title}}">
                </p>
                <p>
                    <label for="modify_rate">Rate</label>
                    <input type="number" name="rate" maxlengh="300" required id="modify_rate" value="{{review.rate}}">
                </p>
                <p>
                    <label for="modify_content">Text</label>
                    <textarea name="rate" maxlengh="300" required id="modify_content" >{{review.content}}</textarea>
                </p>
                <button class="cancel">cancel</button>
                <button class="update">update</button>
            </form>
        </li>
        {% endfor %}
    </ul>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script> <!-- CDN 말고 직접 import 할 수 있는 방법은 없을까. -->
<script>
    // Create Review
    const reviewForm = document.getElementById("review_form");

    function handelSubmitReview(event) {
        event.preventDefault();
        const titleInput = reviewForm.querySelector("#review_title");
        const rateInput = reviewForm.querySelector("#review_rate");
        const contentInput = reviewForm.querySelector("#review_content");

        let data = new FormData(); // !) const가 아니라 let 이어야하는 이유?

        const reviewTitle = titleInput.value;
        const reviewRate = rateInput.value;
        const reviewContent = contentInput.value;

        titleInput.value = ""
        rateInput.value = ""
        contentInput.value = ""

        data.append("title", reviewTitle);
        data.append("rate", reviewRate);
        data.append("content", reviewContent);
        data.append("csrfmiddlewaretoken", '{{csrf_token}}');
        axios.post("/api/{{ movie.pk }}/review/create/", data)
            .then(res => {
                const pk = res.data.pk;
                const title = res.data.title;
                const rate = res.data.rate;
                const content = res.data.content;
                
                const reviewsUl = document.getElementById("reviews");
                const newReview = reviewsUl.querySelector(".new_review");
                newReview.setAttribute("id", `${pk}`);
                const newReviewTitle = newReview.querySelector(".review_title");
                const newReviewRate = newReview.querySelector(".review_rate");
                const newReviewContent = newReview.querySelector(".review_content");
                
                const modifyBtn = newReview.querySelector(".modify");
                const deleteBtn = newReview.querySelector(".delete");
                const modifyForm = newReview.querySelector(".modify_form");
                const modifyTitle = modifyForm.querySelector("#modify_title");
                const modifyRate = modifyForm.querySelector("#modify_rate");
                const modifyContent = modifyForm.querySelector("#modify_content");


                newReviewTitle.innerText = `${title}`;
                newReviewRate.innerText = `rate : ${rate}`;
                newReviewContent.innerText = `${content}`;
                modifyBtn.setAttribute("value", `${pk}`);
                deleteBtn.setAttribute("value", `${pk}`);

                modifyTitle.setAttribute("value", `${title}`);
                modifyRate.setAttribute("value", `${rate}`);
                modifyContent.innerText = `${content}`;

                newReview.hidden = false;

            })
            .catch(errors => console.log(errors.response.data))
    
        
    }

    reviewForm.addEventListener("submit", handelSubmitReview)
</script>
<script>
    // Modify Review
    const modifyBtns = document.getElementsByClassName("modify");
    const updateBtns = document.getElementsByClassName("update");
    const cancelBtns = document.getElementsByClassName("cancel");

    function handleClickModify(event) {
        const modifyBtn = event.target;
        const pk = modifyBtn.value;
        const reviewLi = document.getElementById(`${pk}`);
        const reviewBox = reviewLi.querySelector(".review_box");
        const modifyForm = reviewLi.querySelector(".modify_form");
        const cancelBtn = reviewLi.querySelector(".cancel");
        const updateBtn = reviewLi.querySelector(".update");

        reviewBox.hidden = true;
        modifyForm.hidden = false;

        // cancel 버튼을 누를 때
        cancelBtn.addEventListener("click", (event) => {
            event.preventDefault();
            reviewBox.hidden = false;
            modifyForm.hidden = true;
        })

        // update 버튼으로 form을 submit할때 
        modifyForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const titleInput = modifyForm.querySelector("#modify_title");
            const rateInput = modifyForm.querySelector("#modify_rate");
            const contentInput = modifyForm.querySelector("#modify_content");
    
            const reviewTitle = reviewBox.querySelector(".review_title");
            const reviewRate = reviewBox.querySelector(".review_rate");
            const reviewContent = reviewBox.querySelector(".review_content");
    
            const updateTitle = titleInput.value;
            const updateRate = rateInput.value;
            const updateContent = contentInput.value;

            let data = new FormData(); 
            
            reviewTitle.innerText = `${updateTitle}`;
            reviewRate.innerText = `rate : ${updateRate}`;
            reviewContent.innerText = `${updateContent}`;

            reviewBox.hidden = false;
            modifyForm.hidden = true;

            data.append("pk", pk);
            data.append("title", updateTitle);
            data.append("rate", updateRate);
            data.append("content", updateContent);
            data.append("csrfmiddlewaretoken", '{{csrf_token}}');
    
           
            axios.post("/api/review/update/", data)
            .then(res => alert("Form Submitted"))
            .catch(errors => console.log(errors.response.data));
            
        });
        
        
    }

    for (const modifyBtn of  modifyBtns) {
        modifyBtn.addEventListener("click", handleClickModify);
    }


</script>
<script>
    // Delete review
    const deleteBtns = document.getElementsByClassName("delete");

    function handleClickDelete(event){
        event.preventDefault();
        const deleteBtn = event.target;
        const pk = deleteBtn.value;
        const review = document.getElementById(`${pk}`);
        
        review.hidden = true;

        data = new FormData();

        data.append("pk", pk);
        data.append("csrfmiddlewaretoken", '{{csrf_token}}');

        axios.post("{% url 'reviews:delete' %}", data)
        .then(res => alert("the review is deleted!"))
        .catch(errors => console.log(errors.response.data));
        
    }

    for (const deleteBtn of deleteBtns) {
        deleteBtn.addEventListener("click", handleClickDelete);
    }

</script>

<script>
    //Video Controller
    const video = document.querySelector("video");
    const playBtn = document.getElementById("play");
    const muteBtn = document.getElementById("mute");
    const time = document.getElementById("time");
    const volumeRange = document.getElementById("volume");
    const currentTime = document.getElementById("currentTime");
    const totalTime =  document.getElementById("totalTime");
    const timeline = document.getElementById("timeline");
    const fullscreenBtn = document.getElementById("fullScreen");
    const videoPlayer = document.getElementById("videoPlayer");
    const videoController = document.getElementById("videoController");

    let volumeValue = 0.5;
    video.Volume = volumeValue

    let controllerOutTimeout = null;
    let controllerMovementTimeout = null;

    const handlePlayClick = (e) => {
        if (video.paused) {
            video.play();
        } else{
            video.pause();
        }
        playBtn.innerText = video.paused ? "Play" : "Pause";
    }

    const handleMuteClick = (e) => {
        if (video.muted) {
            video.muted = false;
        } else {
            video.muted = true;
        }
        muteBtn.innerText = video.muted ? "Unmute" : "Mute";
        volumeRange.value = video.muted ? 0 : volumeValue;
    }

    const handleVolumeChange = (e) =>{
        const { target : { value } } = event; 
        
        if (video.muted) {
            video.muted = false;
            muteBtn.innerText = "Mute";
        }
        volumeValue = value;
        video.volume = value;
    }

    const formatTime = (seconds) => new Date(seconds * 1000).toISOString().substr(11, 8);
    // new Date 를 이용한 트릭!

    const handleLoadedMetadata = (e) => {
        totalTime.innerText = formatTime(Math.floor(video.duration));
        timeline.max = Math.floor(video.duration);
    }  // !) e를 쓰는 것과 안쓰는 것의 차이?

    const handleTimeUpdate = (e) => {
        currentTime.innerText = formatTime(Math.floor(video.currentTime));
        timeline.value = Math.floor(video.currentTime);

        if (video.currentTime == video.duration) {
            playBtn.innerText = "Play";
        }
    } 

    const handleTimelineChange = (e) => {
        const { target : { value } } = event; 
        video.currentTime = value;  
    }


    const handleClickFullscreen = () => {
        const fullscreenPlayer = document.fullscreenElement;

        if (fullscreenPlayer != null){
            document.exitFullscreen();
            fullscreenBtn.innerText = "Enter Fullscreen"
        } else {
            videoPlayer.requestFullscreen();
            fullscreenBtn.innerText = "Exit Fullscreen"
        }
    }

    const hideController = () => {
        videoController.classList.remove("showing");
    }

    const handleMouseMove = (event) => {
        if (controllerOutTimeout) {
            clearTimeout(controllerOutTimeout);
            controllerOutTimeout = null;
        }

        if (controllerMovementTimeout) {
            clearTimeout(controllerMovementTimeout);
            controllerMovementTimeout = null; 
        } // 마우스가 움직일때마다 timeout 삭제. 더 이상 움직이지 않으면 controllerMovementTimeout은 아래쪽에 추가된 setTimeout의 값이 됨.
        
        videoController.classList.add("showing");
        controllerMovementTimeout = setTimeout(hideController, 3000);  // 마우스가 움직일때마다 timeout 추가
    }

    const handleMouseLeave = (event) => {
        controllerOutTimeout = setTimeout( hideController, 3000);  
        
    } // setTimeout 은 고유 id를 리턴한다.

    if (video.readyState == 4) {
        handleLoadedMetadata();
        } // JS가 eventListener 를 부착하기 전에 비디오가 완전히 로딩되어버려 MetaData를 받아올 수 없는 경우를 대비.

    playBtn.addEventListener("click", handlePlayClick);
    muteBtn.addEventListener("click", handleMuteClick);
    volumeRange.addEventListener("input", handleVolumeChange);
    video.addEventListener("loadedmetadata", handleLoadedMetadata);
    video.addEventListener("timeupdate", handleTimeUpdate);
    video.addEventListener("mousemove", handleMouseMove);
    video.addEventListener("mouseleave", handleMouseLeave);
    timeline.addEventListener("input", handleTimelineChange);
    fullscreenBtn.addEventListener("click", handleClickFullscreen);
    




</script>
<script>
    // view_count   
    data = new FormData()

    data.append("csrfmiddlewaretoken", '{{csrf_token}}');
    axios.post("{% url 'movies:count_view' movie.pk %}", data)
    .then(res => { return })
    .catch(errors => console.log(errors.response.data));
</script>
{% endblock content %}
